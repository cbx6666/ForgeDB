# MonolithDB 单机存储引擎技术与架构设计文档

> 本文档为 **MonolithDB** 单机存储引擎的技术与架构设计说明，面向高性能存储、查询和数据管理。文档主要展示系统架构、模块功能、核心算法及实现方式，重点体现工程化和系统设计规范。

---

## 1. 项目定位与设计目标

MonolithDB 是一个：

- 高性能单机数据存储引擎
- 支持高并发写入和查询
- 提供数据持久化和崩溃恢复能力

**设计目标：**

1. 高效内存存储结构（MemTable + SkipList）  
2. 顺序写日志（WAL）保证数据可靠性  
3. 磁盘持久化（SSTable + 稀疏索引 + Bloom Filter）  
4. 高效查询（索引优化、范围查询）  
5. 并发安全（Goroutine + Mutex / RWMutex）  
6. 模块化架构，便于扩展与维护  
7. 可观测性（性能指标、日志分析、调试工具）

---

## 2. 系统总体架构

### 2.1 架构分层

1. **接口层（API / Command）**  
   - 提供写入、读取和查询接口  
   - 封装操作为 Command，对外统一暴露

2. **内存存储层（MemTable）**  
   - 使用 SkipList 实现有序内存表  
   - 快速插入、删除、范围遍历

3. **持久化层（WAL & SSTable）**  
   - WAL：顺序写入，保证数据持久化  
   - SSTable：定期刷盘，将 MemTable 数据写入磁盘  
   - 稀疏索引 + Bloom Filter 提高查询效率

4. **并发与调度层**  
   - Goroutine + Worker Pool 处理请求  
   - Mutex / RWMutex 确保线程安全  
   - 请求队列控制并发，避免背压

5. **可观测与调试层**  
   - 性能 Metrics（写入吞吐、查询延迟）  
   - 日志记录、profiling、调试工具

---

### 2.2 架构示意图

```
+---------------------------+
|       API / Command       |
+---------------------------+
            |
            v
+---------------------------+
|        MemTable           |
|   (SkipList 内存存储)     |
+---------------------------+
            |
            v
+---------------------------+
|   WAL（Write-Ahead Log）   |
+---------------------------+
            |
            v
+---------------------------+
|       SSTable 文件         |
|   稀疏索引 + Bloom Filter |
+---------------------------+
            ^
            |
+---------------------------+
| Worker Pool & 并发调度    |
+---------------------------+
            ^
            |
+---------------------------+
| 可观测/性能分析/日志层     |
+---------------------------+
```

---

## 3. 核心模块设计

### 3.1 内存存储模块（MemTable）

- **数据结构**：SkipList  
- **操作支持**：
  - `Put(key, value)`  
  - `Get(key)`  
  - `Delete(key)`  
  - 范围查询  
- **优化点**：
  - 内存有序存储，方便批量刷盘  
  - 支持批量操作减少锁争用

---

### 3.2 持久化日志模块（WAL）

- 顺序追加写，避免随机 IO  
- 每次写入 MemTable 同时写入 WAL  
- **崩溃恢复**：
  - 启动时回放 WAL 恢复 MemTable  
  - 保证数据一致性

---

### 3.3 磁盘存储模块（SSTable）

- **结构**：
  - 数据文件（按 key 排序）  
  - 索引文件（稀疏索引 + Bloom Filter）
- **写入流程**：
  1. MemTable 满时触发 flush  
  2. 写入 SSTable 文件  
  3. 后台 Compaction 减少碎片
- **查询流程**：
  - Bloom Filter + 索引查找  
  - 减少磁盘 IO

---

### 3.4 并发与线程安全

- Goroutine 处理写入/查询请求  
- 内存操作使用 RWMutex 或原子操作保证安全  
- Worker Pool 控制请求队列，防止高并发雪崩

---

## 4. 数据流与操作流程

### 4.1 写入流程

1. 外部请求封装为 Command  
2. 写入 MemTable  
3. 同步写入 WAL  
4. MemTable 满触发 flush → 写入 SSTable

### 4.2 读取流程

1. 查询 MemTable  
2. 未命中查 SSTable（Bloom Filter + 索引）  
3. 返回结果

### 4.3 数据恢复流程

1. 启动时加载 SSTable 索引  
2. 回放 WAL 恢复 MemTable  
3. 系统可继续处理写入与查询

---

## 5. 技术栈总结

| 层级      | 技术与实现                     |
|----------|-------------------------------|
| 编程语言  | Go                             |
| 内存结构  | SkipList / MemTable            |
| 磁盘结构  | SSTable + 稀疏索引 + Bloom Filter |
| 持久化    | Write-Ahead Log (WAL)          |
| 并发模型  | Goroutine + Channel + Mutex/RWMutex |
| 接口设计  | Command 模式                   |
| 可观测性  | Metrics, 日志, Profiling       |

---

## 6. 性能与优化策略

- 批量写入减少锁争用  
- 顺序写 WAL + flush 避免随机写  
- MemTable + SSTable 减少磁盘读取次数  
- Bloom Filter + 稀疏索引提高查询效率  
- 并发 Worker Pool 提高吞吐量

---

## 7. 可扩展性设计

- 模块化架构：
  - MemTable、SSTable、WAL、Command 层解耦  
- 接口抽象：
  - 写入/查询接口可替换底层实现  
  - 后续可增加缓存、压缩或异步任务模块  
- 后台线程：
  - 支持 flush、Compaction、统计分析独立运行

---

## 8. 总结

MonolithDB 单机存储引擎展示了一个**高性能、可扩展、工程化的存储系统**设计：

- 核心技术覆盖内存存储、日志持久化、磁盘结构、索引优化、并发处理  
- 系统分层清晰、模块化，可维护性高  
- 数据流完整，支持高并发写入和查询  
- 可观测性、性能优化和工程化设计保证系统